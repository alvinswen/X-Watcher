# 需求文档

## 简介

X-watcher 当前的定时抓取调度配置（间隔时间、触发时间）仅支持通过环境变量在应用启动时设置，运行期间无法动态调整。本功能为管理员提供 API 端点，允许在不重启服务的情况下动态修改抓取调度参数：设置下次触发抓取的时间，以及设置抓取触发的间隔。修改需要在运行时立即生效，同时持久化到数据库以支持重启后恢复。

## 需求

### 需求 1: 查看当前调度配置

**目标：** 作为管理员，我希望查看当前的调度配置状态（抓取间隔、下次触发时间、调度器运行状态），以便了解系统当前的调度行为。

#### 验收标准

1. When 管理员发送 GET 请求到调度配置端点, the 调度配置 API shall 返回当前的抓取间隔（秒）、下次触发时间、调度器运行状态、最后更新时间和更新人。
2. While 调度器未运行（scraper_enabled=False）, the 调度配置 API shall 返回已保存的配置并标注调度器未运行状态（scheduler_running=false）。
3. While 数据库中没有管理员配置记录, the 调度配置 API shall 返回从环境变量加载的默认配置值。
4. If 未认证或非管理员用户请求此端点, the 调度配置 API shall 返回 401 或 403 错误。

### 需求 2: 设置抓取间隔

**目标：** 作为管理员，我希望动态修改抓取触发的时间间隔，以便根据实际需要调整抓取频率（例如在重大事件期间提高频率）。

#### 验收标准

1. When 管理员提交新的抓取间隔值, the 调度配置服务 shall 将间隔持久化到数据库并立即更新运行中的调度器任务。
2. The 调度配置服务 shall 仅接受 300 秒（5 分钟）到 604800 秒（7 天）范围内的间隔值。
3. If 提交的间隔值超出有效范围, the 调度配置 API shall 返回 422 验证错误并说明有效范围。
4. While 调度器未运行, when 管理员设置抓取间隔, the 调度配置服务 shall 将配置持久化到数据库，并在响应中提示调度器当前未运行、配置将在启用后生效。
5. When 间隔更新成功, the 调度配置 API shall 返回更新后的完整配置信息。
6. If 未认证或非管理员用户请求此端点, the 调度配置 API shall 返回 401 或 403 错误。

### 需求 3: 设置下次触发时间

**目标：** 作为管理员，我希望设置下次抓取的触发时间，以便安排特定时间点执行抓取（例如立即触发一次，或推迟到指定时间）。

#### 验收标准

1. When 管理员提交下次触发时间, the 调度配置服务 shall 将时间持久化到数据库并立即更新运行中调度器任务的下次执行时间。
2. The 调度配置 API shall 仅接受未来时间（允许 30 秒容差以应对请求延迟），且不超过当前时间 30 天。
3. If 提交的时间为过去时间, the 调度配置 API shall 返回 422 验证错误。
4. If 提交的时间超过 30 天后, the 调度配置 API shall 返回 422 验证错误。
5. When 下次触发时间到达并执行抓取后, the 调度器 shall 恢复按已配置的间隔进行后续调度（即下次触发时间是一次性覆盖，不改变间隔行为）。
6. While 调度器未运行, when 管理员设置下次触发时间, the 调度配置服务 shall 将配置持久化到数据库，并在响应中提示调度器当前未运行。
7. If 未认证或非管理员用户请求此端点, the 调度配置 API shall 返回 401 或 403 错误。

### 需求 4: 配置持久化与启动恢复

**目标：** 作为管理员，我希望调度配置的修改在应用重启后仍然生效，以便不必每次重启后重新配置。

#### 验收标准

1. When 应用启动且数据库中存在管理员调度配置, the 调度器 shall 使用数据库中保存的间隔值（而非环境变量默认值）初始化定时任务。
2. When 应用启动且数据库中存在未来的下次触发时间, the 调度器 shall 使用该时间作为首次执行时间。
3. When 应用启动且数据库中不存在调度配置, the 调度器 shall 使用环境变量中的默认间隔值，并立即执行首次抓取（保持现有行为）。
4. The 调度配置服务 shall 在每次配置变更时记录更新时间和更新人标识。

### 需求 5: 管理员认证与权限

**目标：** 作为系统管理员，我希望调度配置管理端点受到管理员认证保护，以防止未授权用户修改系统调度行为。

#### 验收标准

1. The 调度配置 API 的所有端点 shall 要求管理员认证（与现有 `/api/admin/scraping/follows` 使用相同的认证机制）。
2. If 请求缺少认证凭证, the 调度配置 API shall 返回 HTTP 401 未授权错误。
3. If 认证用户不具备管理员权限, the 调度配置 API shall 返回 HTTP 403 禁止访问错误。
